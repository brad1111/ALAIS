#!/bin/bash
#Find RAM
TOTAL_RAM=2048
UEFI=0 #Default is BIOS
user=user
##en d Find Ram
##Find UEFI
  check_boot_system() { ###From Helmuthdu/Aui
    if [[ "$(cat /sys/class/dmi/id/sys_vendor)" == 'Apple Inc.' ]] || [[ "$(cat /sys/class/dmi/id/sys_vendor)" == 'Apple Computer, Inc.' ]]; then
      modprobe -r -q efivars || true  # if MAC
    else
      modprobe -q efivarfs            # all others
    fi
    if [[ -d "/sys/firmware/efi/" ]]; then
      ## Mount efivarfs if it is not already mounted
      if [[ -z $(mount | grep /sys/firmware/efi/efivars) ]]; then
        mount -t efivarfs efivarfs /sys/firmware/efi/efivars
      fi
      UEFI=1
      echo "UEFI Mode detected"
    else
      UEFI=0
      echo "BIOS Mode detected"
    fi
  }
  check_boot_system
##en d Find UEFI
##Start PACMAN
is_package_installed() {
    for PKG in $PKG; do
        pacman -Q $CHKPKGS &> /dev/null && return 0;
    done
    return 1
}


package_install() { 
    for PKG in ${1}; do
        if ! is_package_installed "${PKG}" ; then
            pacman -S --noconfirm --needed ${PKG}
        fi
    done
}

##EN D  PACMAN
check_connection() {
ping -q -w 1 -c 1 `ip r | grep default | awk 'NR==1 {print $3}'` &> /dev/null && return 1 || return 0
}
if [[ check_connection == 0 ]]; then
    echo Please enable your network
    read
    exit 1
fi
  check_trim() {  ##Copied from helmuthdu/aui
    [[ -n $(hdparm -I /dev/sda | grep TRIM &> /dev/null) ]] && TRIM=1
  }
check_trim

# ##Copied from helmuthdu/aui (GPL 3.0)
#     check_vga()
#     {
#         if [[ -n $(dmidecode --type 1 | grep VirtualBox) ]]; then
#       echo Virtualbox
#       VIDEO_DRIVER="virtualbox"
#     elif [[ $_vga_length -eq 2 ]] && [[ -n $(echo ${_vga} | grep "nvidia") || -f /sys/kernel/debug/dri/0/vbios.rom ]]; then
#       echo Bumblebee
#       VIDEO_DRIVER="bumblebee"
#     elif [[ -n $(echo ${_vga} | grep "nvidia") || -f /sys/kernel/debug/dri/0/vbios.rom ]]; then
#       echo Nvidia
#       read_input_text "Install NVIDIA proprietary driver" $PROPRIETARY_DRIVER
#       if [[ $OPTION == y ]]; then
#         VIDEO_DRIVER="nvidia"
#       else
#         VIDEO_DRIVER="nouveau"
#       fi
#     elif [[ -n $(echo ${_vga} | grep "advanced micro devices") || -f /sys/kernel/debug/dri/0/radeon_pm_info || -f /sys/kernel/debug/dri/0/radeon_sa_info ]]; then
#       echo AMD/ATI
#       VIDEO_DRIVER="ati"
#     elif [[ -n $(echo ${_vga} | grep "intel corporation") || -f /sys/kernel/debug/dri/0/i915_capabilities ]]; then
#       echo Intel
#       VIDEO_DRIVER="intel"
#     #Open-VM-Tools support by Thebradad1111 (Checks for VMWare drivers)
#     elif [[ -n $(dmidecode --type 1 | grep VMware) ]]; then
#       echo VMware
#       VIDEO_DRIVER="openvmware"
#     else
#       echo VESA
#       VIDEO_DRIVER="vesa"
#     fi
#     }   ##End of copied from aui
# 
#       replace_line() { #{{{
#     local _search=${1}
#     local _replace=${2}
#     local _filepath=${3}
#     local _filebase=`basename ${3}`
# 
#     sed -e "s/${_search}/${_replace}/" ${_filepath} > /tmp/${_filebase} 2>"$LOG"
#     if [[ ${?} -eq 0 ]]; then
#       mv /tmp/${_filebase} ${_filepath}
#     else
#       cecho "failed: ${_search} - ${_filepath}"
#     fi
#   } #}}}
BOOL_AUTOINST=FALSE
if [[ -f `pwd`/autoinstall ]]; then #Checks for AutoInstall script for arch linux
    source autoinstall
fi

####Config Section
BOOL_MENUCOMPLETE=FALSE
##KEYMAP Section
while [[ $BOOL_MENUCOMPLETE == FALSE ]]; do
    if [[ $BOOL_AUTOINST == FALSE ]]; then
        clear
        echo What keymap do you want DEFAULT=us
        read -p "Keymap:" KEYMAP
        if [[ $KEYMAP == "" ]]; then
            KEYMAP=us
        fi
        BOOL_MENUCOMPLETE=TRUE
    else
        BOOL_MENUCOMPLETE=TRUE
    fi
	break
done

loadkeys $KEYMAP

if [[ $BOOL_AUTOINST == FALSE ]]; then
    BOOL_MENUCOMPLETE=FALSE
    while [[ $BOOL_MENUCOMPLETE == FALSE ]]; do
        clear
        echo What editor do you want as default?
        read -p "Editor:" EDITOR
        if [[ $EDITOR == emacs ]]; then
            EMAC=emacs
            BOOL_MENUCOMPLETE=TRUE
        elif [[ $EDITOR == vim ]]; then
            VIM=vim
            BOOL_MENUCOMPLETE=TRUE
        elif [[ $EDITOR == zile ]]; then
            ZILE=zile
            BOOL_MENUCOMPLETE=TRUE
        elif [[ $EDITOR == nano ]]; then
        BOOL_MENUCOMPLETE=TRUE
        elif [[ $EDITOR == vi ]]; then
        BOOL_MENUCOMPLETE=TRUE
        else
        echo Please enter a valid answer
        read
        fi
    done
fi
package_install "$EDITOR"

####No Mirror Conf Yet
#if [[ $BOOL_AUTOINST == FALSE ]]; then
#    BOOL_MENUCOMPLETE=FALSE
#    while [[ $BOOl_MENUCOMPLETE == FALSE ]]; do
#        
#    done
#fi


##Choose Device
if [[ $BOOL_AUTOINST == FALSE ]]; then
    BOOL_MENUCOMPLETE=FALSE
    while [[ $BOOL_MENUCOMPLETE == FALSE ]]; do
        clear
        echo Showing all Devices
        lsblk
        echo "Ending showing all devices"
        echo "--------------------------"
        echo What device \(hard drive letter a = disk 0\) do you want to install to?
        read DEVICE
        if [[ $DEVICE == "/dev/sd"* ]]; then
            BOOL_MENUCOMPLETE=TRUE
        else
            echo Please enter a valid answer
            read
        fi
    done
 fi
 


##SetFstab
if [[ $BOOL_AUTOINST == FALSE ]]; then
    if [[ -n $(dmidecode --type 1 | grep VirtualBox) ]]; then
        LTS=TRUE
    elif [[ -n $(dmidecode --type 1 | grep VMware) ]]; then
        LTS=TRUE
    fi
    if [[ UEFI == 0 ]]; then
        FSTABTYPE=PARTUUID
    else
        FSTABTYPE=UUID
    fi
fi

##Language
if [[ $BOOL_AUTOINST == FALSE ]]; then
    BOOL_MENUCOMPLETE=FALSE
    while [[ $BOOL_MENUCOMPLETE == FALSE ]]; do
        clear
        echo What language do you want \(e.g. en_US or en_GB\)
        read language
        if [[ $language == *"_"* ]]; then
            BOOL_MENUCOMPLETE=TRUE
        else
            echo Please enter a valid language code
            read
        fi
    done
fi

##Timezone
if [[ $BOOL_AUTOINST == FALSE ]]; then
    BOOL_MENUCOMPLETE=FALSE
    while [[ $BOOL_MENUCOMPLETE == FALSE ]]; do
        clear
        echo What timezone do you want \(e.g. Europe/London, US/Pacific or UTC\)
        read timezone
        if [[ $timezone == */* ]]; then BOOL_MENUCOMPLETE=TRUE
        elif [[ $timezone == UTC ]]; then BOOL_MENUCOMPLETE=TRUE
        elif [[ $timezone == CET ]]; then BOOL_MENUCOMPLETE=TRUE
        elif [[ $timezone == CST6CDT ]]; then BOOL_MENUCOMPLETE=TRUE
        elif [[ $timezone == Cuba ]]; then BOOL_MENUCOMPLETE=TRUE
        elif [[ $timezone == EET ]]; then BOOL_MENUCOMPLETE=TRUE
        elif [[ $timezone == Egypt ]]; then BOOL_MENUCOMPLETE=TRUE
        elif [[ $timezone == Eire ]]; then BOOL_MENUCOMPLETE=TRUE
        elif [[ $timezone == EST ]]; then BOOL_MENUCOMPLETE=TRUE
        elif [[ $timezone == EST5EDT ]]; then BOOL_MENUCOMPLETE=TRUE
        elif [[ $timezone == Factory ]]; then BOOL_MENUCOMPLETE=TRUE
        elif [[ $timezone == GB ]]; then BOOL_MENUCOMPLETE=TRUE
        elif [[ $timezone == GB-Eire ]]; then BOOL_MENUCOMPLETE=TRUE
        elif [[ $timezone == "GMT"* ]]; then BOOL_MENUCOMPLETE=TRUE
        elif [[ $timezone == Greenwich ]]; then BOOL_MENUCOMPLETE=TRUE
        elif [[ $timezone == Hongkong ]]; then BOOL_MENUCOMPLETE=TRUE
        elif [[ $timezone == HST ]]; then BOOL_MENUCOMPLETE=TRUE
        elif [[ $timezone == Iceland ]]; then BOOL_MENUCOMPLETE=TRUE
        elif [[ $timezone == Iran ]]; then BOOL_MENUCOMPLETE=TRUE
        #elif [[ $timezone == iso3166.tab ]]; then BOOL_MENUCOMPLETE=TRUE
        elif [[ $timezone == Israel ]]; then BOOL_MENUCOMPLETE=TRUE
        elif [[ $timezone == Jamaica ]]; then BOOL_MENUCOMPLETE=TRUE
        elif [[ $timezone == Japan ]]; then BOOL_MENUCOMPLETE=TRUE
        elif [[ $timezone == Kwajalein ]]; then BOOL_MENUCOMPLETE=TRUE
        elif [[ $timezone == Libya ]]; then BOOL_MENUCOMPLETE=TRUE
        elif [[ $timezone == MET ]]; then BOOL_MENUCOMPLETE=TRUE
        elif [[ $timezone == "MST"* ]]; then BOOL_MENUCOMPLETE=TRUE
        elif [[ $timezone == Navajo ]]; then BOOL_MENUCOMPLETE=TRUE
        elif [[ $timezone == NZ ]]; then BOOL_MENUCOMPLETE=TRUE
        elif [[ $timezone == NZ-CHAT ]]; then BOOL_MENUCOMPLETE=TRUE
        elif [[ $timezone == Poland ]]; then BOOL_MENUCOMPLETE=TRUE
        elif [[ $timezone == Portugal ]]; then BOOL_MENUCOMPLETE=TRUE
        elif [[ $timezone == posixrules ]]; then BOOL_MENUCOMPLETE=TRUE
        elif [[ $timezone == PRC ]]; then BOOL_MENUCOMPLETE=TRUE
        elif [[ $timezone == PSR8PDT ]]; then BOOL_MENUCOMPLETE=TRUE
        elif [[ $timezone == ROC ]]; then BOOL_MENUCOMPLETE=TRUE
        elif [[ $timezone == ROK ]]; then BOOL_MENUCOMPLETE=TRUE
        elif [[ $timezone == Singapore ]]; then BOOL_MENUCOMPLETE=TRUE
        elif [[ $timezone == Turkey ]]; then BOOL_MENUCOMPLETE=TRUE
        elif [[ $timezone == UCT ]]; then BOOL_MENUCOMPLETE=TRUE
        elif [[ $timezone == Universal ]]; then BOOL_MENUCOMPLETE=TRUE
        elif [[ $timezone == W-SU ]]; then BOOL_MENUCOMPLETE=TRUE
        elif [[ $timezone == Zulu ]]; then BOOL_MENUCOMPLETE=TRUE
        else
            echo Please enter a valid timezone
            read
        fi
    done
fi

##Set hardware-clock
if [[ $BOOL_AUTOINST == FALSE ]]; then
    BOOL_MENUCOMPLETE=FALSE
    while [[ $BOOL_MENUCOMPLETE == FALSE ]]; do
        clear
        echo Please set the hardware clock \(UTC or Localtime\) \(UTC Recommended, Localtime if dualbooting with Windows\)
        read hwclockvar
        if [[ $hwclockvar == UTC ]]; then
        hwclockvar=utc
        break
        elif [[ $hwclockvar == Localtime ]]; then
        hwclockvar=localtime
        break
        else
            echo Please enter a valid hwclock value
            read
        fi
    done
fi

##Hostname
if [[ $BOOL_AUTOINST == FALSE ]]; then
    BOOL_MENUCOMPLETE=FALSE
    while [[ $BOOL_MENUCOMPLETE == FALSE ]]; do
        clear
        echo Please set the hostname for your new system
        read hostname
        break
    done
fi

##Network manager thing
if [[ $BOOL_AUTOINST == FALSE ]]; then
    BOOL_MENUCOMPLETE=FALSE
    while [[ $BOOL_MENUCOMPLETE == FALSE ]]; do
        clear
        echo Please set your network manager \(Networkmanager, Connman, or Wicd\)
        read networkman
        if [[ $networkman == Networkmanager ]]; then
        $networkman=networkmanager
        break
        elif [[ $networkman == Connman ]]; then
        $networkman=connman
        break
        elif [[ $networkman == Wicd ]]; then
        $networkman=wicd
        break
        else
            echo Please enter a valid network manager
            read
        fi
    done
fi

##Password (PLEASE BE TEMPORARY) For now
if [[ $BOOL_AUTOINST == FALSE ]]; then
    BOOL_MENUCOMPLETE=FALSE
    while [[ $BOOL_MENUCOMPLETE == FALSE ]]; do
        clear
        echo Please enter a TEMPORARY password that you will change later whilst you are logged in \(this is because it is insecure\)
        read password
        break
    done
fi


##Octopi Setup for POST Config Wizard
Octopi()
{
    clear
    echo Do you want to install octopi \(pacman in gui form made in qt\) \[Y/N\]?
    local octopiYN
    read octopiYN
    if [[ $octopiYN == Y ]]; then
        BOOL_OCTOPI=TRUE
    elif [[ $octopiYN == N ]]; then
        BOOL_OCTOPI=FALSE
    else
        echo Please enter a valid answer
        read
    fi
}

##Post Config Wizard
#Same as below but w/o wizard
PConfPKGS()
{
    while [[ $BOOL_MENUCOMPLETE == FALSE ]]; do
        clear
        CUSTOMPKGS=
        AURCUSTOMPKGS=
        echo What applications do you want to install \(e.g. application1 application2 etc.\) \[PACMAN\]
        read CUSTOMPKGS
        echo What applications do you want to install \(e.g. application application etc.\) \[AUR\]
        read AURCUSTOMPKGS
    done
}
PConfWiz()
{
    #BasicSetup
    while [[ $BOOL_MENUCOMPLETE == FALSE ]]; do
        clear
        local basicsetupYN
        echo Do you want basic setup \(bc, rsync, mlocate bash-completeion pkgstats, ntp, avahi, alsa, pulseaudio, file systems\) \[Y/N\]
        read basicsetup
        if [[ $basicsetup == Y ]]; then
            BOOL_BASICSETUP=TRUE
            break
        elif [[ $basicsetup == N ]]; then
            BOOL_BASICSETUP=FALSE
            break
        else
            echo Please enter a valid answer \[Y/N\]
            read
        fi
    done
    #SSH
    while [[ $BOOL_MENUCOMPLETE == FALSE ]]; do
        clear
        local sshYN
        echo Do you want SSH? \[Y/N\]
        read sshYN
        if [[ $sshYN == Y ]]; then
            BOOL_SSH=TRUE
            break
        elif [[ $sshYN == N ]]; then
            BOOL_SSH=FALSE
            break
        else
            echo Please enter a valid answer \[Y/N\]
            read
        fi
    done
    #NFS
    while [[ $BOOL_MENUCOMPLETE == FALSE ]]; do
        clear
        local nfsYN
        echo Do you want NFS? \[Y/N\]
        read nfsYN
        if [[ $nfsYN == Y ]]; then
            BOOL_NFS=TRUE
            break
        elif [[ $nfsYN == N ]]; then
            BOOL_NFS=FALSE
            break
        else
            echo Please enter a valid answer \[Y/N\]
            read
        fi
    done
    #Samba
    while [[ $BOOL_MENUCOMPLETE == FALSE ]]; do
        clear
        local sambaYN
        echo Do you want Samba? \[Y/N\]
        read sambaYN
        if [[ $sambaYN == Y ]]; then
            BOOL_SAMBA=TRUE
            break
        elif [[ $sambaYN == N ]]; then
            BOOL_SAMBA=FALSE
            break
        else
            echo Please enter a valid answer \[Y/N\]
            read
        fi
    done
    #Readahead
    while [[ $BOOL_MENUCOMPLETE == FALSE ]]; do
        clear
        local readaheadYN
        echo Do you want Readahead? \[Y/N\]
        read readaheadYN
        if [[ $readaheadYN == Y ]]; then
            BOOL_READAHEAD=TRUE
            break
        elif [[ $readaheadYN == N ]]; then
            BOOL_READAHEAD=FALSE
            break
        else
            echo Please enter a valid answer \[Y/N\]
            read
        fi
    done
    #Fontconfig
    while [[ $BOOL_MENUCOMPLETE == FALSE ]]; do
        clear
        local fontconfigOPTION
        echo What fontconfig \[Normal, Infinality, Ubuntu\] \[1,2,3\]
        read fontconfigOPTION
        if [[ $fontconfigOPTION == 1 ]]; then
            FONTCONFIG=NORM
            break
        elif [[ $fontconfigOPTION == 2 ]]; then
            FONTCONFIG=INF
            break
        elif [[ $fontconfigOPTION == 3 ]]; then
            FONTCONFIG=UBUNTU
            break
        else
            echo Please enter a valid answer \[Y/N\]
            read
        fi
    done
    #XORG
    while [[ $BOOL_MENUCOMPLETE == FALSE ]]; do
        clear
        local xorgYN
        echo Do you want XORG \(required for a gui\)? \[Y/N\]
        read xorgYN
        if [[ $xorgYN == Y ]]; then
            BOOL_XORG=TRUE
            break
        elif [[ $xorgYN == N ]]; then
            BOOL_XORG=FALSE
            break
        else
            echo Please enter a valid answer \[Y/N\]
            read
        fi
    done
    check_vga
    ##CUPS
    while [[ $BOOL_MENUCOMPLETE == FALSE ]]; do
        clear
        local cupsYN
        echo Do you want CUPS \(printing support\)?
        read cupsYN
        if [[ $cupsYN == Y ]]; then
            BOOL_CUPS=TRUE
            break
        elif [[ $cupsYN == N ]]; then
            BOOL_CUPS=FALSE
            break
        else
            echo Please enter a valid answer \[Y/N\]
            read
        fi
    done
    ##WM/DE
    while [[ $BOOL_MENUCOMPLETE == FALSE ]]; do
        if [[ $BOOL_XORG == TRUE ]]; then
            clear
            local deYN
            echo Do you want a desktop enironment/window manager \(gnome, kde etc./openbox, i3 etc.\)
            read deYN
            if [[ deYN == Y ]]; then
                local BOOL_2NDMENUCOMPLETE=FALSE
                while [[ $BOOL_2NDMENUCOMPLETE == FALSE ]]; do
                    clear
                    echo Please select a desktop environment or window manager
                    echo -----------------------------------------------------
                    echo Desktop Environment:   Window Manager:
                    echo 1. Cinnamon            9. Awesome
                    echo 2. Enlightenment       10. Fluxbox
                    echo 3. GNOME               11. i3
                    echo 4. KDE                 12. OpenBox
                    echo 5. LXDE                13. Xmonad
                    echo 6. LXQT
                    echo 7. MATE
                    echo 8. XFCE
                    echo -----------------------------------------------------
                    echo Please select a number from 1-13:
                    local wm
                    read wm
                    if [[ $wm == 1 ]]; then
                        DESKTOP_ENV=Cinnamon
                        BOOL_2NDMENUCOMPLETE=TRUE
                    elif [[ $wm == 2 ]]; then
                        DESKTOP_ENV=Enlightenment
                        BOOL_2NDMENUCOMPLETE=TRUE
                    elif [[ $wm == 3 ]]; then
                        DESKTOP_ENV=GNOME
                        BOOL_2NDMENUCOMPLETE=TRUE
                    elif [[ $wm == 4 ]]; then
                        DESKTOP_ENV=KDE
                        BOOL_2NDMENUCOMPLETE=TRUE
                    elif [[ $wm == 5 ]]; then
                        DESKTOP_ENV=LXDE
                        BOOL_2NDMENUCOMPLETE=TRUE
                    elif [[ $wm == 6 ]]; then
                        DESKTOP_ENV=LXQT
                        BOOL_2NDMENUCOMPLETE=TRUE
                    elif [[ $wm == 7 ]]; then
                        DESKTOP_ENV=MATE
                        BOOL_2NDMENUCOMPLETE=TRUE
                    elif [[ $wm == 8 ]]; then
                        DESKTOP_ENV=XFCE
                        BOOL_2NDMENUCOMPLETE=TRUE
                    elif [[ $wm == 9 ]]; then
                        DESKTOP_ENV=Awesome
                        BOOL_2NDMENUCOMPLETE=TRUE
                    elif [[ $wm == 10 ]]; then
                        DESKTOP_ENV=Fluxbox
                        BOOL_2NDMENUCOMPLETE=TRUE
                    elif [[ $wm == 11 ]]; then
                        DESKTOP_ENV=i3
                        BOOL_2NDMENUCOMPLETE=TRUE
                    elif [[ $wm == 12 ]]; then
                        DESKTOP_ENV=Openbox
                        BOOL_2NDMENUCOMPLETE=TRUE
                    elif [[ $wm == 13 ]]; then
                        DESKTOP_ENV=Xmonad
                        BOOL_2NDMENUCOMPLETE=TRUE
                    else
                        echo Please enter a valid number [1-13]
                        read
                    fi
                done
                break
            elif [[ deYN == N ]]; then
                break
            fi
        else
            break
        fi
    done
    ##Todo add different DM support
    DISPLAY_MAN_GREETER=
    if [[ $DESKTOP_ENV == KDE ]]; then
        DISPLAY_MAN=sddm
    elif [[ $DESKTOP_ENV == LXQT ]]; then
        DISPLAY_MAN=sddm
    elif [[ $DESKTOP_ENV == "" ]]; then #NO DESKTOP ENVIRONMENT
        DISPLAY_MAN=
    elif [[ $DESKTOP_ENV == GNOME ]]; then
        DISPLAY_MAN=gdm
    elif [[ $DESKTOP_ENV == LXDE ]]; then
        DISPLAY_MAN=lxdm
    else
        DISPLAY_MAN=lightdm
        DISPLAY_MAN_GREETER=lightdm-gtk-greeter
    fi
    


    
    
    while [[ $BOOL_MENUCOMPLETE == FALSE ]]; do
        if [[ $DESKTOP_ENV == "" ]]; then
            break
        elif [[ $DESKTOP_ENV == KDE ]] || [[ $DESKTOP_ENV == LXQT ]]; then
            octopi
            if [[ $BOOL_OCTOPI == TRUE ]] || [[ $BOOL_OCTOPI == FALSE ]]; then
                break
            fi
        else
            clear
            echo Do you want to install pacman \(pacman in gui form made in gtk+/vala\) \[Y/N\]?
            local pamacYN
            read pamacYN
            if [[ $pamacYN == Y ]]; then
                BOOL_PAMAC=TRUE
                break
            elif [[ $pamacYN == N ]]; then
                BOOL_PAMAC=FALSE
                break
            else
                echo Please enter a valid answer
                read
            fi
        fi
    done
    
    while [[ $BOOL_MENUCOMPLETE == FALSE ]]; do
        clear
        local plymouthYN
        echo Do you want to install Plymouth? \(A boot-screen/boot-splash\) \[Y/N\]
        read plymouthYN
        if [[ $plymouthYN == Y ]]; then
            BOOL_PLYMOUTH=TRUE
            PLYMOUTH_THEME=SPINFINITY
            PLYMOUTH_VARIANT=-legacy
            break
        elif [[ $plymouthYN == N ]]; then
            BOOL_PLYMOUTH=FALSE
            break
        else
            echo Please enter a valid answer
            read
        fi
    done
    
    
    while [[ $BOOL_MENUCOMPLETE == FALSE ]]; do
        clear
        local MorePKGSYN
        echo Do you want to add more packages after install? \[Y/N\]
        read MorePKGSYN
        if [[ $MorePKGSYN == TRUE ]]; then
            PConfPKGS
        fi
    done
}



##Post config
if [[ $BOOL_AUTOINST == FALSE ]]; then
    BOOL_MENUCOMPLETE=FALSE
    while [[ $BOOL_MENUCOMPLETE == FALSE ]]; do
        clear
        echo Do you want to use a wizard to setup post-install, or just choose the applications? \[Y/N\]
        read temp_postconfig
        if [[ $temp_postconfig == Y ]]; then
            PConfWiz
            break
        elif [[ $temp_postconfig == N ]]; then
            break
        else
            echo Please enter a valid answer \[Y/N\]
            read
        fi
    done
fi

####Config en d
####Installation Start
# DEVICE_PARTITION_TABLE=NULL
# DEVICE_ESP=
# DEVICE_SWAP=
# DEVICE_ROOT=
# if [[ $BOOL_AUTOINST == FALSE ]]; then partitioner=parted; fi
# partition_man()
# {
#     if [[ $partitioner == parted ]]; then
#         if [[ %{1} == msdos ]]; then
#             parted $DEVICE mklabel msdos
#             DEVICE_PARTITION_TABLE=msdos
#             
#         elif [[ %{1} == gpt ]]; then
#             parted $DEVICE mklabel gpt
#             DEVICE_PARTITION_TABLE=gpt
#         elif [[ %{1} == esp ]]; then
#             parted $DEVICE mkpart primary fat32 2M 512M
#             DEVICE_ESP={$DEVICE}1
#         elif [[ %{1} == swap ]]; then
#             parted $DEVICE mkpart primary linux-swap 513M $TOTAL_RAM
#             if [[ $DEVICE_ESP == "" ]]; then DEVICE_SWAP={$DEVICE}1; else DEVICE_SWAP={$DEVICE}2; fi
#         elif [[ %{1} == root ]]; then
#             parted $DEVICE mkpart primary ext4 100%
#             if [[ $DEVICE_SWAP == {$DEVICE}1 ]]; then DEVICE_ROOT={$DEVICE}2; elif [[ $DEVICE_SWAP == {$DEVICE}2 ]]; then DEVICE_ROOT={$DEVICE}3; else echo An Error occured partitioning Root; read; exit 1; fi
#             if [[ $DEVICE_PARTITION_TABLE == msdos ]] && [[ $UEFI == 0 ]]; then
#                 parted $DEVICE set 2 boot on #MBR BOOTABLE PARITITON
#             fi
#         fi
#     fi
# }
# 
# 
# #Choose Partition ##NO current support for BIOS/gpt + grub
# #if [[ $BOOL_AUTOINST == FALSE ]]; then
#  BOOL_MENUCOMPLETE=FALSE 
#  while [[ $BOOL_MENUCOMPLETE == FALSE ]]; do
#        clear
#        ###Later enable BIOS boot partition etc
#        ###UEFI Partition
#         if [[ $UEFI == 1 ]]; then
#            partition_man "gpt"
#            partition_man "esp"
#         else
#            partition_man "msdos"
#         fi
#        partition_man "swap"
#        partition_man "root"
#        break
#  done
# #fi

if [[ $UEFI == 1 ]]; then
    parted $DEVICE mklabel gpt yes
    DEVICE_PARTITION_TABLE=gpt
    parted $DEVICE mkpart primary fat32 2M 512M
    DEVICE_ESP=${DEVICE}1
else
    parted $DEVICE mklabel msdos yes
    DEVICE_PARTITION_TABLE=msdos
fi
parted $DEVICE mkpart primary linux-swap 513M $TOTAL_RAM
if [[ $DEVICE_ESP == ${DEVICE}1 ]]; then
    DEVICE_SWAP=${DEVICE}2
else
    DEVICE_SWAP=${DEVICE}1
fi
parted $DEVICE mkpart primary ext4 $TOTAL_RAM 100%
if [[ $DEVICE_SWAP == ${DEVICE}1 ]]; then
    DEVICE_ROOT=${DEVICE}2
elif [[ $DEVICE_SWAP == ${DEVICE}2 ]]; then
    DEVICE_ROOT=${DEVICE}3
else
    echo An Error occured partitioning Root
    read
    exit 1
fi





##Create partitions
if [[ $TRIM == 1 ]]; then temptrimcommand="-E discard"; fi
mkswap $DEVICE_SWAP
swapon $DEVICE_SWAP
if [[ $UEFI == 1 ]]; then mkfs.fat -F32 $DEVICE_ESP; fi
mkfs.ext4 $DEVICE_ROOT $temptrimcommand <<EOF
y
EOF


mount $DEVICE_ROOT /mnt
if [[ $UEFI == 1 ]]; then
    mkdir /mnt/boot
    mount $DEVICE_ESP /mnt/boot
fi






pacstraptodo="base base-devel $networkman grub os-prober efibootmgr dosfstools dkms"
if [[ $LTS == TRUE ]]; then
    pacstraptodo="$pacstraptodo linux-lts linux-lts-headers"
else
    pacstraptodo="$pacstraptodo linux-headers"
fi

pacstrap /mnt $pacstraptodo


if [[ ! $language == en_US ]]; then echo $language.UTF-8 UTF-8 >> /mnt/etc/locale.gen; fi
echo en_US.UTF-8 UTF-8 >> /mnt/etc/locale.gen

arch-chroot /mnt locale-gen

echo LANG=$language > /mnt/etc/locale.conf
echo KEYMAP=$keymap > /mnt/etc/vconsole.conf


arch-chroot /mnt ln -s /usr/share/zoneinfo/$timezone /etc/localtime
arch-chroot /mnt hwclock --$hwclockvar --systohc


echo $hostname > /mnt/etc/hostname
arch-chroot /mnt sed -i '/127.0.0.1/s/$/ '${hostname}'/' /etc/hosts
arch-chroot /mnt sed -i '/::1/s/$/ '${hostname}'/' /etc/hosts


if [[ $LTS == TRUE ]]; then
    arch-chroot /mnt pacman -Rs --noconfirm linux
    arch-chroot /mnt mkinitcpio -p linux-lts
else
    arch-chroot /mnt mkinitcpio -p linux
fi

if [[ $UEFI == 1 ]]; then
    arch-chroot /mnt grub-install --target=x86_64-efi --efi-directory=/boot --bootloader-id=arch-linux
else
    arch-chroot /mnt grub-install --target=i386-pc $DEVICE
fi
arch-chroot /mnt grub-mkconfig -o /boot/grub/grub.cfg

arch-chroot /mnt passwd <<EOF
$password
$password
EOF

if [[ $networkman == networkmanager ]]; then arch-chroot /mnt systemctl enable NetworkManager; else; arch-chroot /mnt systemctl enable $networkman; fi

arch-chroot /mnt systemctl enable $networkman
#if [[ $DEVICE_ESP == "" ]]; then
#    echo &> /dev/null
#else
#    umount -R /mnt/boot
#fi
#umount -R /mnt
#swapoff $DEVICE_SWAP


#systemctl reboot
##en d of install
##Todo add config stuff

# 
# BOOL_BASICSETUP=FALSE
# BOOL_SSH=FALSE
# BOOL_NFS=FALSE
# BOOL_SAMBA=FALSE
# BOOL_READAHEAD=FALSE
# FONTCONFIG=NORM #Will change to nonbool
# BOOL_XORG=FALSE
# BOOL_CUPS=FALSE
# DESKTOP_ENV= #No window manager/destop environment because no xorg
# DISPLAY_MAN= #No display manager because no xorg
# BOOL_PAMAC=FALSE    #No pamac or octopi because there is no xorg/wm/de
# BOOL_OCTOPI=FALSE
# BOOL_PLYMOUTH=FALSE
# 

# USER=

ARCHI=`uname -m` #Architecture

if [[ $ARCHI == x86_64 ]]; then
    _has_multilib=`grep -n "\n[multilib\]" /etc/pacman.conf | cut -f1 -d:`
    if [[ -z $_has_multilib ]]; then
        echo -e "\n[multilib]\nInclude = /etc/pacman.d/mirrorlist" >> /etc/pacman.conf
        echo -e "\nMultilib repository added to pacman.conf"
    else
        sed -i "${_has_multilib}s/^#//" /etc/pacman.conf
        _has_multilib=$(( ${_has_multilib} + 1 ))
        sed -i "${_has_multilib}s/^#//" /etc/pacman.conf
    fi
fi ##Copied from helmuthdu/aui
arch-chroot /mnt useradd -m -G wheel -s /bin/bash $user
arch-chroot /mnt passwd $user <<EOF
$password
$password
EOF
sed -i '/%wheel ALL=(ALL) ALL/s/^#//' /mnt/etc/sudoers
TEMPADDEDTOPOSTINST=
TEMPADDEDAUR=
BOOL_UBUNTUCONF=FALSE
if [[ $BOOL_BASICSETUP == TRUE ]]; then TEMPADDEDTOPOSTINST="$TEMPADDEDTOPOSTINST bc rsync mlocate bash-completion pkgstats ntp zip unzip unrar p7zip lzop cpio avahi nss-mdns alsa-utils alsa-plugins pulseaudio pulseaudio-alsa ntfs-3g dosfstools exfat-utils f2fs-tools fuse fuse-exfat autofs"; fi
if [[ $BOOL_BASICSETUP == TRUE ]] && [[ $ARCH == x86_64 ]]; then TEMPADDEDTOPOSTINST="$TEMPADDEDTOPOSTINST lib32-alsa-plugins lib32-libpulse"; fi
if [[ $BOOL_SSH == TRUE ]]; then TEMPADDEDTOPOSTINST="$TEMPADDEDTOPOSTINST openssh"; fi
if [[ $BOOL_NFS == TRUE ]]; then TEMPADDEDTOPOSTINST="$TEMPADDEDTOPOSTINST nfs-utils"; fi
if [[ $BOOL_SAMBA == TRUE ]]; then TEMPADDEDTOPOSTINST="$TEMPADDEDTOPOSTINST samba smbnetfs"; fi
if [[ $FONTCONFIG == NORM ]]; then TEMPADDEDTOPOSTINST="$TEMPADDEDTOPOSTINST cairo fontconfig freetype2"; fi
if [[ $FONTCONFIG == INF ]]; then TEMPADDEDTOPOSTINST="$TEMPADDEDTOPOSTINST infinality-bundle"
if [[ $FONTCONFIG == INF ]] && [[ $ARCH == x86_64 ]]; then TEMPADDEDTOPOSTINST="$TEMPADDEDTOPOSTINST infinality-bundle-multilib"; fi
if [[ $FONTCONFIG == UBUNTU ]]; then BOOL_UBUNTUCONF=TRUE; fi
if [[ $BOOL_XORG == TRUE ]]; then
    TEMPADDEDTOPOSTINST="$TEMPADDEDTOPOSTINST xorg-server xorg-server-utils xorg-server-xwayland xorg-xinit xorg-xkill xf86-input-synaptics xf86-input-mouse xf86-input-keyboard xf86-input-wacom xf86-input-libinput mesa"
    _vga=`lspci | grep VGA | tr "[:upper:]" "[:lower:]"`
    _vga_length=`lspci | grep VGA | wc -l`
    pacstrap /mnt dmidecode
    pacman --noconfirm -S dmidecode
    if [[ -n $(dmidecode --type 1 | grep VirtualBox) ]]; then
    #VBOX
    arch-chroot /mnt pacman --noconfirm -S --needed virtualbox-guest-utils mesa-libgl virtualbox-guest-dkms
    if [[ ${ARCHI} == x86_64 ]]; then arch-chroot /mnt pacman --noconfirm -S --needed lib32-mesa-libgl;fi
    arch-chroot /mnt gpasswd -a $user vboxsf
    #arch-chroot /mnt systemctl diable ntpd
    arch-chroot /mnt systemctl enable vboxservice
    elif [[ $_vga_length -eq 2 ]] && [[ -n $(echo ${_vga} | grep "nvidia") || -f /sys/kernel/debug/dri/0/vbios.rom ]]; then
    #NVidia bumblebee
    arch-chroot /mnt pacman --noconfirm -S --needed xf86-video-intel bumblebee nvidia
    [[ ${ARCHI} == x86_64 ]] && arch-chroot /mnt pacman --noconfirm -S --needed lib32-nvidia-utils
    replace_line '*options nouveau modeset=1' '#options nouveau modeset=1' /mnt/etc/modprobe.d/modprobe.conf
    replace_line '*MODULES="nouveau"' '#MODULES="nouveau"' /mnt/etc/mkinitcpio.conf
    arch-chroot /mnt mkinitcpio -p linux
    arch-chroot /mnt mkinitcpio -p linux-lts
    arch-chroot /mnt gpasswd -a $user bumblebee
    elif [[ -n $(echo ${_vga} | grep "nvidia") || -f /sys/kernel/debug/dri/0/vbios.rom ]]; then
    #Nvidia (Proprietary)
    arch-chroot /mnt pacman --noconfirm -S --needed libva-vdpau-driver nvidia nvidia-utils
    [[ ${ARCHI} == x86_64 ]] && arch-chroot /mnt pacman --noconfirm -S --needed lib32-nvidia-utils
    replace_line '*options nouveau modeset=1' '#options nouveau modeset=1' /mnt/etc/modprobe.d/modprobe.conf
    replace_line '*MODULES="nouveau"' '#MODULES="nouveau"' /mnt/etc/mkinitcpio.conf
    arch-chroot /mnt mkinitcpio -p linux
    arch-chroot /mnt mkinitcpio -p linux-lts
    arch-chroot /mnt nvidia-xconfig --add-arg-glx-visuals --allow-glx-with-composite --composite -no-logo --render-accel -o /etc/X11/xorg.conf.d/20-nvidia.conf;
    echo export LIBVA_DRIVER_NAME=vdpau >> /mnt/etc/profile
    elif [[ -n $(echo ${_vga} | grep "advanced micro devices" || -f /sys/kernel/debug/dri/0/radeon_pm_info || -f /sys/kernel/debug/dri/0/radeon_sa_info ]]; then
    #AMD/ATI
    [[ -f /mnt/etc/X11/xorg.conf.d/20-radeon.conf ]] && rm /etc/X11/xorg.conf.d/20-radeon.conf
    [[ -f /mnt/etc/modules-load.d/catalyst.conf ]] && rm /etc/modules-load.d/catalyst.conf
    [[ -f /mnt/etc/X11/xorg.conf ]] && rm /etc/X11/xorg.conf
    arch-chroot /mnt pacman --noconfirm -S --needed xf86-video-ati mesa-libgl mesa-vdpau libva-vdpau-driver
    echo export LIBVA_DRIVER_NAME=vdpau >> /mnt/etc/profile
    if [[ ${ARCHI} == x86_64 ]]; then arch-chroot /mnt pacman --noconfirm -S --needed lib32-mesa-vdpau;fi
    if [[ ${ARCHI} == x86_64 ]]; then arch-chroot /mnt pacman --noconfirm -S --needed lib32-mesa-libgl;fi
    elif [[ -n $(echo ${_vga} | grep "intel corporation") || -f /sys/kernel/debug/dri/0/i915_capabilities ]]; then
    #Intel
    arch-chroot /mnt pacman --noconfirm -S --needed xf86-video-intel mesa-libgl libva-intel-driver
    if [[ ${ARCHI} == x86_64 ]]; then arch-chroot /mnt pacman --noconfirm -S --needed lib32-mesa-libgl;fi
    else
    #VESA
    arch-chroot /mnt pacman --noconfirm -S --needed xf86-video-vesa mesa-libgl libva-vdpau-driver
    if [[ ${ARCHI} == x86_64 ]]; then arch-chroot /mnt pacman --noconfirm -S --needed lib32-mesa-libgl;fi
    echo export LIBVA_DRIVER_NAME=vdpau >> /mnt/etc/profile
    fi
    
fi



if [[ $BOOL_CUPS == TRUE ]]; then TEMPADDEDTOPOSTINST="$TEMPADDEDTOPOSTINST cups cups-filters ghostscript gsfonts gutenprint foomatic-db foomatic-db-engine foomatic-db-nonfree foomatic-filters hplip splix cups-pdf system-config-printer"; fi

if [[ $LOCALE == pt_BR || $LOCALE == en_GB || $LOCALE == zn_CN ]]; then
    LOCALE_KDE=`echo $LOCALE | tr '[:upper:]' '[:lower:]'`
elif [[ $LOCALE == en_US ]]; then
    LOCALE_KDE="en_gb"
else
    LOCALE_KDE=`echo $LOCALE | cut -d\_ -f1`
fi

#DESKTOPENV
if [[ $DESKTOP_ENV == Cinnamon ]] && [[ $BOOL_XORG == TRUE ]]; then TEMPADDEDTOPOSTINST="$TEMPADDEDTOPOSTINST cinnamon nemo-fileroller nemo-preview"; fi
if [[ $DESKTOP_ENV == Enlightenment ]] && [[ $BOOL_XORG == TRUE ]]; then TEMPADDEDTOPOSTINST="$TEMPADDEDTOPOSTINST enlightenment terminology leafpad epdfview lxappearance"; fi
if [[ $DESKTOP_ENV == GNOME ]] && [[ $BOOL_XORG == TRUE ]]; then TEMPADDEDTOPOSTINST="$TEMPADDEDTOPOSTINST gnome gnome-extra telepathy gedit-plugins gpaste gnome-tweak-tool gnome-power-manager gucharmap gvfs-goa deja-dup"; fi
if [[ $DESKTOP_ENV == KDE ]] && [[ $BOOL_XORG == TRUE ]]; then TEMPADDEDTOPOSTINST="$TEMPADDEDTOPOSTINST plasma kde-applications-meta kde-meta-kdenetwork kde-meta-kdeutils kde-l10n-$LOCALE_KDE sddm kio-mtp"; fi
if [[ $DESKTOP_ENV == LXDE ]] && [[ $BOOL_XORG == TRUE ]]; then TEMPADDEDTOPOSTINST="$TEMPADDEDTOPOSTINST lxde leafpad obconf epdfview"; fi
if [[ $DESKTOP_ENV == LXQT ]] && [[ $BOOL_XORG == TRUE ]]; then TEMPADDEDTOPOSTINST="$TEMPADDEDTOPOSTINST lxqt openbox oxygen-icons qtcurve leafpad epdfview kio-mtp"; fi
if [[ $DESKTOP_ENV == MATE ]] && [[ $BOOL_XORG == TRUE ]]; then TEMPADDEDTOPOSTINST="$TEMPADDEDTOPOSTINST mate mate-extra"; fi
if [[ $DESKTOP_ENV == XFCE ]] && [[ $BOOL_XORG == TRUE ]]; then TEMPADDEDTOPOSTINST="$TEMPADDEDTOPOSTINST xfce4 xfce4-goodies xarchiver mupdf"; fi
if [[ $DESKTOP_ENV == Awesome ]] && [[ $BOOL_XORG == TRUE ]]; then TEMPADDEDTOPOSTINST="$TEMPADDEDTOPOSTINST awesome lxappearance leafpad epdfview nitrogen"; fi
if [[ $DESKTOP_ENV == Fluxbox ]] && [[ $BOOL_XORG == TRUE ]]; then TEMPADDEDTOPOSTINST="$TEMPADDEDTOPOSTINST fluxbox menumaker lxappearance leafpad epdfview"; fi
if [[ $DESKTOP_ENV == i3 ]] && [[ $BOOL_XORG == TRUE ]]; then TEMPADDEDTOPOSTINST="$TEMPADDEDTOPOSTINST i3 dmenu"; fi
if [[ $DESKTOP_ENV == Openbox ]] && [[ $BOOL_XORG == TRUE ]]; then TEMPADDEDTOPOSTINST="$TEMPADDEDTOPOSTINST openbox obconf obmenu menumaker lxappearance leafpad epdfview nitrogen"; fi
if [[ $DESKTOP_ENV == Xmonad ]] && [[ $BOOL_XORG == TRUE ]]; then TEMPADDEDTOPOSTINST="$TEMPADDEDTOPOSTINST xmonad xmonad-contrib"; fi

if [[ $DESKTOP_ENV != KDE ]] && [[ $DESKTOP_ENV != LXQT ]]; then TEMPADDEDTOPOSTINST="$TEMPADDEDTOPOSTINST gvfs gvfs-mtp gvfs-afc gvfs-gogle xdg-user-dirs pavucontrol ttf-bitstream-vera ttf-dejavu gnome-defaults-list"; fi
TEMPADDEDTOPOSTINST="$TEMPADDEDTOPOSTINST $DISPLAY_MAN $DISPLAY_MAN_GREETER"
TEMPADDEDTOPOSTINST="$TEMPADDEDTOPOSTINST wxgtk2.8"
mkdir -p /mnt/home/$user/.compose-cache
pacstrap /mnt $TEMPADDEDTOPOSTINST
